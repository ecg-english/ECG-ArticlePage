<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Community Hub</title>
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* スクロールバー非表示（横スクロール用） */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.router('home')">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">E</div>
                <h1 class="text-xl font-bold tracking-tight text-blue-900">ECG <span class="text-gray-500 font-normal text-sm ml-1">Community Hub</span></h1>
            </div>

            <!-- PC Menu -->
            <nav class="hidden md:flex items-center gap-6">
                <button onclick="app.router('home')" class="text-sm font-medium text-gray-500 hover:text-blue-600 transition-colors" id="nav-home">
                    Community Feed
                </button>
                <button onclick="app.router('admin')" class="flex items-center gap-1 px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors" id="nav-admin">
                    <i data-lucide="pen-tool" class="w-4 h-4"></i>
                    Staff Write
                </button>
            </nav>

            <!-- Mobile Menu Button -->
            <button class="md:hidden p-2" onclick="app.toggleMenu()">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t px-4 py-4 space-y-3 shadow-lg">
            <button onclick="app.router('home'); app.toggleMenu()" class="block w-full text-left py-2 text-gray-700">Community Feed</button>
            <button onclick="app.router('admin'); app.toggleMenu()" class="block w-full text-left py-2 text-blue-600 font-medium">Staff Login (Write)</button>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-5xl mx-auto px-4 py-8 flex-grow w-full">
        
        <!-- ローディング表示 -->
        <div id="loading-indicator" class="hidden flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 text-sm">Loading articles from ECG Cloud...</p>
        </div>

        <!-- 1. ホーム画面（記事一覧） -->
        <div id="view-home" class="space-y-8 hidden">
            <!-- ヒーローセクション -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 md:p-10 text-white shadow-lg relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-2xl md:text-3xl font-bold mb-2">Welcome to ECG Article</h2>
                    <p class="text-blue-100 mb-6 max-w-xl">
                        スタッフやコーチが発信する英語学習のヒント、異文化体験、イベント情報をチェックしよう。
                    </p>
                    <div class="relative max-w-md">
                        <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="気になるキーワードで検索..." 
                            class="w-full pl-10 pr-4 py-3 rounded-xl text-gray-800 shadow-sm focus:ring-2 focus:ring-blue-300 outline-none"
                            oninput="app.filterArticles()"
                        />
                    </div>
                </div>
                <div class="absolute right-0 top-0 h-full w-1/3 bg-white opacity-5 transform skew-x-12 translate-x-10"></div>
            </div>

            <!-- タグフィルター -->
            <div id="tags-container" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <!-- JSで動的に生成 -->
            </div>

            <!-- 記事グリッド -->
            <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JSで動的に生成 -->
            </div>
            
            <!-- 記事なしメッセージ -->
            <div id="no-articles-msg" class="hidden text-center py-20 text-gray-500">
                <p>記事が見つかりませんでした。</p>
            </div>
        </div>

        <!-- 2. 記事詳細画面 -->
        <div id="view-article" class="max-w-3xl mx-auto hidden">
            <button onclick="app.router('home')" class="flex items-center text-gray-500 hover:text-blue-600 mb-6 transition-colors">
                <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
                Back to Feed
            </button>

            <article class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div id="detail-image-container" class="w-full h-64 md:h-80 overflow-hidden hidden">
                    <img id="detail-image" src="" alt="" class="w-full h-full object-cover">
                </div>
                
                <div class="p-6 md:p-10">
                    <div class="flex items-center gap-2 mb-4">
                        <span id="detail-category" class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded-full"></span>
                        <span id="detail-date" class="text-gray-400 text-sm"></span>
                    </div>

                    <h1 id="detail-title" class="text-2xl md:text-4xl font-bold text-gray-900 mb-6 leading-tight"></h1>

                    <div class="flex items-center gap-3 mb-8 pb-8 border-b border-gray-100">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p id="detail-author" class="text-sm font-bold text-gray-800"></p>
                            <p class="text-xs text-gray-500">ECG Staff Member</p>
                        </div>
                    </div>

                    <div id="detail-content" class="prose prose-blue max-w-none text-gray-700 leading-relaxed whitespace-pre-wrap"></div>

                    <div class="mt-10 pt-6 border-t border-gray-100">
                        <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                            <i data-lucide="tag" class="w-4 h-4"></i> Related Tags
                        </h4>
                        <div id="detail-tags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </article>
        </div>

        <!-- 3. 管理者（投稿）画面 -->
        <div id="view-admin" class="hidden">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-gray-100 p-6 md:p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-gray-800">
                        <i data-lucide="pen-tool" class="text-blue-600 w-5 h-5"></i>
                        New Article
                    </h2>
                    <button onclick="app.router('home')" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <form id="article-form" onsubmit="app.submitArticle(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input required name="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: 今週の英会話Tips">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Author Name</label>
                            <input required name="author" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: Kairi">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select name="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="General">General</option>
                                <option value="English Tips">English Tips</option>
                                <option value="Events">Events</option>
                                <option value="Culture">Culture</option>
                                <option value="Staff Voice">Staff Voice</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                        <textarea required name="content" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="ここに記事の内容を書いてください..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Image URL (Optional)</label>
                            <input name="image" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags (Comma separated)</label>
                            <input name="tags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="英語, イベント, 初心者">
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Publish Article
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="bg-white border-t mt-12 py-8">
        <div class="max-w-5xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2025 English Gym ECG. All rights reserved.</p>
            <p class="mt-2 text-xs">Empowering Global Citizens.</p>
        </div>
    </footer>

    <!-- アプリケーションロジック -->
    <script>
        // --- 設定 ---
        const CONFIG = {
            // ご提示いただいたGASのWebアプリURL
            API_URL: "https://script.google.com/macros/s/AKfycby7DlTI_iddr3Vbf5HYyuPRZM8dc6xhoyG0FPLzlKvfCp6olKiVttjiZRBAAstyXU2Kwg/exec",
            INITIAL_DATA: [
                // フォールバック用データ（APIエラー時などに表示）
                {
                    id: 1,
                    title: "Welcome to ECG Hub",
                    author: "System",
                    content: "データベースに接続しています... もしこの記事が表示され続けている場合は、インターネット接続を確認してください。",
                    category: "System",
                    date: "2025-04-01",
                    tags: ["Info"],
                    image: ""
                }
            ]
        };

        // --- アプリ状態管理 ---
        const app = {
            articles: [],
            currentTag: "All",
            
            // 初期化
            init: async () => {
                lucide.createIcons();
                await app.fetchArticles();
                app.router('home');
            },

            // データ取得 (GASからFetch)
            fetchArticles: async () => {
                app.toggleLoading(true);
                try {
                    const response = await fetch(CONFIG.API_URL);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    // データが配列か確認、そうでなければ空配列
                    app.articles = Array.isArray(data) ? data : [];
                    
                    // 日付順にソート（新しい順）
                    app.articles.sort((a, b) => new Date(b.date) - new Date(a.date));

                } catch (error) {
                    console.error("Fetch error:", error);
                    // エラー時はローカルストレージを確認、それもなければ初期データ
                    const localData = localStorage.getItem('ecg_articles_backup');
                    if (localData) {
                        app.articles = JSON.parse(localData);
                        console.log("Loaded from local backup");
                    } else {
                        app.articles = CONFIG.INITIAL_DATA;
                    }
                    // alert("サーバーからのデータ取得に失敗しました。オフラインモードで表示します。");
                } finally {
                    app.toggleLoading(false);
                    app.renderArticles();
                    app.renderTags();
                }
            },

            // 記事投稿 (GASへPOST)
            submitArticle: async (event) => {
                event.preventDefault();
                const form = event.target;
                const btn = document.getElementById('submit-btn');
                const originalBtnText = btn.innerHTML;

                // ボタンをローディング状態に
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-2 border-white border-t-transparent inline-block mr-2"></div> Sending...`;

                const formData = new FormData(form);
                const newArticle = {
                    id: Date.now(), // 一時的なID
                    title: formData.get('title'),
                    author: formData.get('author'),
                    category: formData.get('category'),
                    content: formData.get('content'),
                    image: formData.get('image'),
                    tags: formData.get('tags').split(',').map(t => t.trim()).filter(t => t),
                    date: new Date().toISOString().split('T')[0]
                };

                try {
                    // GASへのPOSTリクエスト
                    // 注意: GASへのPOSTはCORSエラーが出やすいため、no-corsモードやtext/plainを使うのが定石
                    const response = await fetch(CONFIG.API_URL, {
                        method: 'POST',
                        // GASで受け取るために文字列化して送る。
                        // 重要: Content-Typeをapplication/jsonにするとGAS側でOPTIONSプリフライトが走り失敗することがある。
                        // text/plainとして送り、GAS側で JSON.parse(e.postData.contents) するのが一番確実。
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify(newArticle)
                    });

                    const result = await response.json();
                    console.log("Post result:", result);

                    // 成功したらローカルの状態も更新して画面遷移
                    app.articles.unshift(newArticle);
                    
                    // バックアップ用ローカルストレージも更新
                    localStorage.setItem('ecg_articles_backup', JSON.stringify(app.articles));
                    
                    form.reset();
                    alert("記事が投稿されました！");
                    app.router('home');
                    app.renderArticles(); // リスト再描画

                } catch (error) {
                    console.error("Post error:", error);
                    alert("投稿に失敗しました。コンソールを確認してください。\n" + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                }
            },

            // 画面遷移ルーティング
            router: (viewName) => {
                // 全画面非表示
                ['view-home', 'view-article', 'view-admin'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                
                // ナビゲーションのアクティブ状態
                const navHome = document.getElementById('nav-home');
                const navAdmin = document.getElementById('nav-admin');
                
                if (navHome) navHome.className = "text-sm font-medium text-gray-500 hover:text-blue-600 transition-colors";
                if (navAdmin) navAdmin.className = "flex items-center gap-1 px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors";

                // 指定画面表示
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
                window.scrollTo(0, 0);

                if (viewName === 'home') {
                    if(navHome) navHome.className = "text-sm font-medium text-blue-600";
                    app.renderArticles(); // 戻った時に再描画
                } else if (viewName === 'admin') {
                    if(navAdmin) navAdmin.className = "flex items-center gap-1 px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-700 transition-colors";
                }
            },

            // 記事詳細表示
            showArticle: (id) => {
                const article = app.articles.find(a => a.id == id);
                if (!article) return;

                document.getElementById('detail-title').textContent = article.title;
                document.getElementById('detail-author').textContent = article.author;
                document.getElementById('detail-category').textContent = article.category;
                document.getElementById('detail-date').textContent = article.date;
                document.getElementById('detail-content').textContent = article.content;

                // 画像処理
                const imgContainer = document.getElementById('detail-image-container');
                const img = document.getElementById('detail-image');
                if (article.image) {
                    img.src = article.image;
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }

                // タグ処理
                const tagsContainer = document.getElementById('detail-tags');
                tagsContainer.innerHTML = '';
                if (article.tags && Array.isArray(article.tags)) {
                    article.tags.forEach(tag => {
                        const span = document.createElement('span');
                        span.className = "bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm";
                        span.textContent = `#${tag}`;
                        tagsContainer.appendChild(span);
                    });
                }

                app.router('article');
                lucide.createIcons();
            },

            // 記事リスト描画
            renderArticles: () => {
                const grid = document.getElementById('articles-grid');
                const noMsg = document.getElementById('no-articles-msg');
                const searchVal = document.getElementById('search-input').value.toLowerCase();

                grid.innerHTML = '';

                const filtered = app.articles.filter(a => {
                    const matchSearch = a.title.toLowerCase().includes(searchVal) || a.content.toLowerCase().includes(searchVal);
                    const matchTag = app.currentTag === "All" || (a.tags && a.tags.includes(app.currentTag));
                    return matchSearch && matchTag;
                });

                if (filtered.length === 0) {
                    noMsg.classList.remove('hidden');
                } else {
                    noMsg.classList.add('hidden');
                    filtered.forEach(article => {
                        const card = document.createElement('article');
                        card.className = "bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow cursor-pointer group flex flex-col h-full";
                        card.onclick = () => app.showArticle(article.id);

                        // 画像部分
                        let imageHtml = '';
                        if (article.image) {
                            imageHtml = `<img src="${article.image}" alt="${article.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`;
                        } else {
                            imageHtml = `<div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-200"><i data-lucide="image" class="w-12 h-12"></i></div>`;
                        }

                        // タグ部分
                        let tagsHtml = '';
                        if (article.tags && Array.isArray(article.tags)) {
                            tagsHtml = article.tags.map(t => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">#${t}</span>`).join('');
                        }

                        card.innerHTML = `
                            <div class="h-48 overflow-hidden bg-gray-200 relative">
                                ${imageHtml}
                                <div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-2 py-1 rounded text-xs font-bold text-blue-800 shadow-sm">
                                    ${article.category}
                                </div>
                            </div>
                            <div class="p-5 flex flex-col flex-grow">
                                <div class="flex items-center gap-2 text-xs text-gray-500 mb-2">
                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                    <span>${article.date}</span>
                                    <span class="mx-1">•</span>
                                    <i data-lucide="user" class="w-3 h-3"></i>
                                    <span>${article.author}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-3 line-clamp-2 leading-tight group-hover:text-blue-600 transition-colors">
                                    ${article.title}
                                </h3>
                                <p class="text-gray-600 text-sm line-clamp-3 mb-4 flex-grow">
                                    ${article.content}
                                </p>
                                <div class="flex flex-wrap gap-1 mt-auto">
                                    ${tagsHtml}
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    lucide.createIcons();
                }
            },

            // タグ描画
            renderTags: () => {
                const container = document.getElementById('tags-container');
                container.innerHTML = '';

                // 全タグ抽出
                const allTags = new Set(["All"]);
                app.articles.forEach(a => {
                    if (a.tags && Array.isArray(a.tags)) {
                        a.tags.forEach(t => allTags.add(t));
                    }
                });

                allTags.forEach(tag => {
                    const btn = document.createElement('button');
                    const isActive = app.currentTag === tag;
                    btn.className = `px-4 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors ${isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`;
                    btn.textContent = tag;
                    btn.onclick = () => {
                        app.currentTag = tag;
                        app.renderTags(); // ボタン状態更新のため再描画
                        app.renderArticles();
                    };
                    container.appendChild(btn);
                });
            },

            filterArticles: () => {
                app.renderArticles();
            },

            toggleLoading: (isLoading) => {
                const loader = document.getElementById('loading-indicator');
                const home = document.getElementById('view-home');
                if (isLoading) {
                    loader.classList.remove('hidden');
                    loader.classList.add('flex');
                    home.classList.add('hidden');
                } else {
                    loader.classList.add('hidden');
                    loader.classList.remove('flex');
                    home.classList.remove('hidden');
                }
            },

            toggleMenu: () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            }
        };

        // アプリ起動
        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>